<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FaceRecognition — Register</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css">
  <style>
    main { grid-template-columns: 1fr; max-width: 780px; }

    .nav-link {
      font-family: var(--mono);
      font-size: 0.72rem;
      color: var(--muted);
      text-decoration: none;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      border-bottom: 1px solid transparent;
      transition: color 0.2s, border-color 0.2s;
    }
    .nav-link:hover { color: var(--accent); border-color: var(--accent); }

    .name-input-wrap {
      position: relative;
      border: 2px solid var(--border);
      margin-top: 14px;
    }
    .name-label {
      position: absolute;
      top: 7px; left: 12px;
      font-family: var(--mono);
      font-size: 0.6rem;
      letter-spacing: 0.12em;
      color: var(--muted);
      text-transform: uppercase;
      pointer-events: none;
    }
    input[type=text] {
      width: 100%;
      padding: 26px 12px 8px;
      border: none;
      background: var(--surface);
      font-family: var(--mono);
      font-size: 1rem;
      color: var(--text);
      outline: none;
      letter-spacing: 0.06em;
    }
    input[type=text]:focus { background: var(--bg); }

    .progress-wrap {
      border: 2px solid var(--border);
      padding: 16px;
      background: var(--surface);
    }
    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .progress-label {
      font-family: var(--mono);
      font-size: 0.65rem;
      letter-spacing: 0.14em;
      color: var(--muted);
      text-transform: uppercase;
    }
    .progress-count {
      font-family: var(--mono);
      font-size: 0.85rem;
      color: var(--accent);
    }
    .progress-track { height: 4px; background: var(--border); overflow: hidden; }
    .progress-fill  { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }

    .samples-grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 4px;
      margin-top: 10px;
    }
    .sample-dot {
      aspect-ratio: 1;
      border: 1px solid var(--border);
      background: var(--surface);
      overflow: hidden;
    }
    .sample-dot.captured { border-color: var(--accent); }
    .sample-dot img { width: 100%; height: 100%; object-fit: cover; display: block; opacity: 0; transition: opacity 0.2s; }
    .sample-dot.captured img { opacity: 1; }

    .banner {
      display: none;
      border: 2px solid var(--border);
      padding: 14px 16px;
      font-family: var(--mono);
      font-size: 0.8rem;
      letter-spacing: 0.06em;
      text-align: center;
      background: var(--surface);
      margin-top: 12px;
    }
    .banner.visible { display: block; }
    .banner.success { border-color: var(--accent); color: var(--accent); background: var(--bg); }
    .banner.error   { border-color: var(--danger); color: var(--danger); }

    #activity-log {
      font-family: var(--mono);
      font-size: 0.7rem;
      color: var(--muted);
      line-height: 1.7;
      max-height: 110px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }
    #activity-log .entry { display: flex; gap: 8px; }
    #activity-log .ts  { color: var(--muted); flex-shrink: 0; }
    #activity-log .ok  { color: var(--accent); }
    #activity-log .err { color: var(--danger); }
  </style>
</head>
<body>

<header>
  <div class="logo">Face<span>Reg</span></div>
  <div style="display:flex; align-items:center; gap:20px;">
    <a href="/" class="nav-link">← Recognition</a>
    <div class="status-pill">
      <div class="dot" id="status-dot"></div>
      <span id="status-text">OFFLINE</span>
    </div>
  </div>
</header>

<main>

  <!-- Camera -->
  <div>
    <div class="camera-wrap">
      <div class="camera-placeholder" id="placeholder">
        <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
          <path d="M15 10l4.553-2.069A1 1 0 0121 8.87v6.26a1 1 0 01-1.447.894L15 14M3 8a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2V8z"/>
        </svg>
        <span>CAMERA INACTIVE</span>
      </div>
      <video id="video" autoplay muted playsinline></video>
      <div class="scan-line" id="scan-line"></div>

      <!-- Countdown overlay -->
      <div id="countdown-overlay" style="display:none; position:absolute; inset:0; background:rgba(0,0,0,0.55); align-items:center; justify-content:center; z-index:20; flex-direction:column; gap:8px;">
        <div id="countdown-num" style="font-family:var(--mono); font-size:5rem; color:#fff; line-height:1;"></div>
        <div style="font-family:var(--mono); font-size:0.7rem; color:rgba(255,255,255,0.5); letter-spacing:0.14em; text-transform:uppercase;">GET READY</div>
      </div>

      <!-- Flash -->
      <div id="flash" style="display:none; position:absolute; inset:0; background:white; opacity:0; z-index:21; pointer-events:none;"></div>
    </div>

    <!-- Name input -->
    <div class="name-input-wrap">
      <div class="name-label">Person Name / ID</div>
      <input type="text" id="name-input" placeholder="e.g. george" autocomplete="off" spellcheck="false" />
    </div>

    <!-- Controls -->
    <div class="controls" style="margin-top:10px;">
      <button class="primary" id="btn-start">START CAMERA</button>
      <button id="btn-capture" disabled>CAPTURE (0/20)</button>
      <button id="btn-stop" disabled>STOP</button>
    </div>
  </div>

  <!-- Progress grid -->
  <div class="progress-wrap">
    <div class="progress-header">
      <span class="progress-label">Captured Samples</span>
      <span class="progress-count" id="prog-count">0 / 20</span>
    </div>
    <div class="progress-track"><div class="progress-fill" id="prog-fill"></div></div>
    <div class="samples-grid" id="samples-grid"></div>
  </div>

  <!-- Save panel -->
  <div class="panel">
    <div class="panel-label">Save Dataset</div>
    <div class="controls" style="margin-top:0;">
      <button class="primary" id="btn-save" disabled>SAVE TO DATASET</button>
      <button id="btn-reset">RESET</button>
    </div>
    <div class="banner" id="banner"></div>
    <div class="panel-label" style="margin-top:14px;">Activity Log</div>
    <div id="activity-log"></div>
  </div>

</main>

<script>
const TOTAL_SAMPLES    = 20;
const CAPTURE_DELAY_MS = 300;

let stream         = null;
let running        = false;
let capturing      = false;
let capturedFrames = [];

const video            = document.getElementById("video");
const placeholder      = document.getElementById("placeholder");
const scanLine         = document.getElementById("scan-line");
const dot              = document.getElementById("status-dot");
const statusTxt        = document.getElementById("status-text");
const btnStart         = document.getElementById("btn-start");
const btnCapture       = document.getElementById("btn-capture");
const btnStop          = document.getElementById("btn-stop");
const btnSave          = document.getElementById("btn-save");
const btnReset         = document.getElementById("btn-reset");
const nameInput        = document.getElementById("name-input");
const progFill         = document.getElementById("prog-fill");
const progCount        = document.getElementById("prog-count");
const samplesGrid      = document.getElementById("samples-grid");
const banner           = document.getElementById("banner");
const logEl            = document.getElementById("activity-log");
const countdownOverlay = document.getElementById("countdown-overlay");
const countdownNum     = document.getElementById("countdown-num");
const flash            = document.getElementById("flash");

function buildGrid() {
  samplesGrid.innerHTML = "";
  for (let i = 0; i < TOTAL_SAMPLES; i++) {
    const d = document.createElement("div");
    d.className = "sample-dot";
    d.id = `dot-${i}`;
    d.appendChild(document.createElement("img"));
    samplesGrid.appendChild(d);
  }
}
buildGrid();

function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

function log(msg, type = "") {
  const ts    = new Date().toLocaleTimeString("en", { hour12: false });
  const entry = document.createElement("div");
  entry.className = "entry";
  entry.innerHTML = `<span class="ts">${ts}</span><span class="${type}">${msg}</span>`;
  logEl.prepend(entry);
  while (logEl.children.length > 60) logEl.removeChild(logEl.lastChild);
}

function setStatus(state) {
  dot.className = "dot " + (state || "");
  statusTxt.textContent = state === "live" ? "LIVE" : state === "error" ? "ERROR" : "OFFLINE";
}

function showBanner(msg, type) { banner.textContent = msg; banner.className = `banner visible ${type}`; }
function hideBanner()          { banner.className = "banner"; }

function updateProgress() {
  const n = capturedFrames.length;
  progFill.style.width   = `${(n / TOTAL_SAMPLES) * 100}%`;
  progCount.textContent  = `${n} / ${TOTAL_SAMPLES}`;
  btnCapture.textContent = `CAPTURE (${n}/${TOTAL_SAMPLES})`;
  btnSave.disabled       = n === 0 || !nameInput.value.trim();
  if (n >= TOTAL_SAMPLES) btnCapture.disabled = true;
}

function doFlash() {
  flash.style.display = "block";
  flash.style.opacity = "0.7";
  setTimeout(() => {
    flash.style.transition = "opacity 0.3s";
    flash.style.opacity    = "0";
    setTimeout(() => { flash.style.display = "none"; flash.style.transition = ""; }, 350);
  }, 60);
}

function captureFrame() {
  if (!running || video.readyState < 2) return null;
  const tmp = document.createElement("canvas");
  tmp.width  = video.videoWidth;
  tmp.height = video.videoHeight;
  tmp.getContext("2d").drawImage(video, 0, 0);
  return tmp.toDataURL("image/jpeg", 0.92);
}

async function runBurst() {
  if (capturing) return;
  capturing = true;
  btnCapture.disabled = true;

  for (let i = 3; i >= 1; i--) {
    countdownOverlay.style.display = "flex";
    countdownNum.textContent = i;
    await delay(900);
  }
  countdownOverlay.style.display = "none";

  while (capturedFrames.length < TOTAL_SAMPLES && running) {
    const dataUrl = captureFrame();
    if (!dataUrl) break;
    const idx = capturedFrames.length;
    capturedFrames.push(dataUrl);
    const dotEl = document.getElementById(`dot-${idx}`);
    if (dotEl) { dotEl.querySelector("img").src = dataUrl; dotEl.classList.add("captured"); }
    doFlash();
    updateProgress();
    log(`Sample ${idx + 1}/${TOTAL_SAMPLES} captured`, "ok");
    await delay(CAPTURE_DELAY_MS);
  }

  capturing = false;
  if (capturedFrames.length < TOTAL_SAMPLES) btnCapture.disabled = false;
  updateProgress();
}

btnStart.addEventListener("click", async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 }, audio: false });
    video.srcObject = stream;
    await video.play();
    placeholder.style.display = "none";
    running = true;
    scanLine.classList.add("active");
    setStatus("live");
    btnStart.disabled   = true;
    btnCapture.disabled = false;
    btnStop.disabled    = false;
    log("Camera started", "ok");
  } catch (err) {
    log(`Camera error: ${err.message}`, "err");
    setStatus("error");
  }
});

btnStop.addEventListener("click", () => {
  running = false;
  capturing = false;
  if (stream) stream.getTracks().forEach(t => t.stop());
  stream = null;
  video.srcObject = null;
  placeholder.style.display     = "flex";
  countdownOverlay.style.display = "none";
  scanLine.classList.remove("active");
  setStatus("");
  btnStart.disabled   = false;
  btnCapture.disabled = true;
  btnStop.disabled    = true;
  log("Camera stopped");
});

btnCapture.addEventListener("click", () => {
  if (!nameInput.value.trim()) {
    nameInput.focus();
    nameInput.style.outline = "2px solid var(--accent)";
    setTimeout(() => nameInput.style.outline = "", 1200);
    log("Enter a name before capturing", "err");
    return;
  }
  runBurst();
});

nameInput.addEventListener("input", updateProgress);

btnSave.addEventListener("click", async () => {
  const name = nameInput.value.trim().toLowerCase().replace(/\s+/g, "_");
  if (!name)                       { log("Enter a name first", "err"); return; }
  if (capturedFrames.length === 0) { log("No frames captured", "err"); return; }

  btnSave.disabled  = true;
  btnReset.disabled = true;
  hideBanner();
  log(`Saving ${capturedFrames.length} images for "${name}"...`);

  try {
    const res  = await fetch("/register", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, images: capturedFrames })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || `HTTP ${res.status}`);
    showBanner(`✓ Saved ${data.saved} images to dataset/train/${name}/`, "success");
    log(`Saved ${data.saved} images for "${name}"`, "ok");
  } catch (err) {
    showBanner(err.message, "error");
    log(`Save failed: ${err.message}`, "err");
    btnSave.disabled = false;
  }

  btnReset.disabled = false;
});

btnReset.addEventListener("click", () => {
  capturedFrames = [];
  buildGrid();
  nameInput.value = "";
  hideBanner();
  updateProgress();
  if (running) btnCapture.disabled = false;
  log("Reset. Ready for new capture.");
});
</script>
</body>
</html>